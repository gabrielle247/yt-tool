
// ==========================================
// FILE: ./main.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:transparent_image/transparent_image.dart';
import 'video_model.dart';
import 'yt_service.dart';

void main() {
  runApp(const TheYTApp());
}

class TheYTApp extends StatelessWidget {
  const TheYTApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'The YT',
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        brightness: Brightness.dark,
        scaffoldBackgroundColor: const Color(0xFF121212), // Greyway Dark
        primaryColor: const Color(0xFF00AAFF), // Greyway Blue
        useMaterial3: true,
        textTheme: GoogleFonts.jetBrainsMonoTextTheme(
          ThemeData.dark().textTheme,
        ),
        colorScheme: const ColorScheme.dark(
          primary: Color(0xFF00AAFF),
          secondary: Color(0xFF00AAFF),
          surface: Color(0xFF1E1E1E),
        ),
      ),
      home: const HomeScreen(),
    );
  }
}

class HomeScreen extends StatefulWidget {
  const HomeScreen({super.key});

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  final TextEditingController _searchController = TextEditingController();
  final ScrollController _consoleScroll = ScrollController();
  final YtService _ytService = YtService();
  
  List<VideoModel> _results = [];
  final List<String> _consoleLogs = [];
  
  bool _isLoading = false;
  bool _showConsole = false;
  String _statusMessage = "System Online.";

  @override
  void initState() {
    super.initState();
    _checkDisclaimer();
  }

  Future<void> _checkDisclaimer() async {
    // We check if the user has accepted the terms recently
    // For now, we show it on every fresh launch to be safe, 
    // or uncomment the logic below to save state.
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _showLiabilityDialog();
    });
  }

  void _showLiabilityDialog() {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF1E1E1E),
        title: const Row(
          children: [
            Icon(Icons.warning_amber_rounded, color: Colors.orange),
            SizedBox(width: 10),
            Text("User Responsibility"),
          ],
        ),
        content: const Text(
          "The YT is a powerful archiving utility provided by Greyway.Co.\n\n"
          "By proceeding, you acknowledge that you are solely responsible for compliance with all applicable copyright laws and terms of service of the platforms you access.\n\n"
          "Greyway.Co assumes no liability for misuse of this tool.",
          style: TextStyle(color: Colors.white70),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(), 
            child: const Text("I ACCEPT", style: TextStyle(color: Color(0xFF00AAFF), fontWeight: FontWeight.bold)),
          ),
        ],
      ),
    );
  }

  void _addLog(String message) {
    if (message.isEmpty) return;
    setState(() {
      _consoleLogs.add(message);
    });
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (_consoleScroll.hasClients) {
        _consoleScroll.jumpTo(_consoleScroll.position.maxScrollExtent);
      }
    });
  }

  Future<void> _handleSearch() async {
    final query = _searchController.text.trim();
    if (query.isEmpty) return;

    setState(() {
      _isLoading = true;
      _statusMessage = "Scanning...";
      _results = [];
      _consoleLogs.clear();
    });

    _addLog("> Fetching metadata for: $query");
    
    final videos = await _ytService.searchOrFetch(query);

    setState(() {
      _results = videos;
      _isLoading = false;
      _statusMessage = "Found ${videos.length} items.";
    });
    
    _addLog("> Scan complete. ${videos.length} found.");
  }

  void _download(VideoModel video) {
    setState(() {
      video.isDownloading = true;
      _showConsole = true; 
    });

    _addLog("> Initiating download: ${video.title}");

    _ytService.downloadVideo(video, (log) {
      _addLog(log);
    }).then((_) {
      if (mounted) {
        setState(() {
          video.isDownloading = false;
          video.isCompleted = true;
          _statusMessage = "Saved: ${video.title}";
        });
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Column(
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            color: const Color(0xFF1E1E1E),
            child: Row(
              children: [
                const Icon(Icons.slow_motion_video, color: Color(0xFF00AAFF), size: 30),
                const SizedBox(width: 16),
                Expanded(
                  child: TextField(
                    controller: _searchController,
                    onSubmitted: (_) => _handleSearch(),
                    style: const TextStyle(color: Colors.white, fontSize: 14),
                    decoration: InputDecoration(
                      hintText: 'Search or Paste Link...',
                      hintStyle: TextStyle(color: Colors.grey[600]),
                      filled: true,
                      fillColor: const Color(0xFF121212),
                      isDense: true,
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(4),
                        borderSide: BorderSide.none,
                      ),
                      focusedBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(4),
                        borderSide: const BorderSide(color: Color(0xFF00AAFF)),
                      ),
                    ),
                  ),
                ),
                const SizedBox(width: 10),
                IconButton(
                  onPressed: _isLoading ? null : _handleSearch,
                  icon: _isLoading 
                    ? const SizedBox(width: 18, height: 18, child: CircularProgressIndicator(strokeWidth: 2))
                    : const Icon(Icons.play_arrow, color: Color(0xFF00AAFF)),
                ),
              ],
            ),
          ),
          
          // Results
          Expanded(
            child: _results.isEmpty && !_isLoading
              ? Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Text("The YT", style: TextStyle(color: Colors.grey[800], fontSize: 24, fontWeight: FontWeight.bold)),
                      const SizedBox(height: 8),
                      Text("Archive Responsibly.", style: TextStyle(color: Colors.grey[800], fontSize: 12)),
                    ],
                  ),
                )
              : ListView.builder(
                  padding: const EdgeInsets.all(20),
                  itemCount: _results.length,
                  itemBuilder: (context, index) => _buildCard(_results[index]),
                ),
          ),

          // Activity Log (Renamed from Console)
          if (_showConsole)
            Container(
              height: 150,
              width: double.infinity,
              color: Colors.black,
              padding: const EdgeInsets.all(10),
              child: ListView.builder(
                controller: _consoleScroll,
                itemCount: _consoleLogs.length,
                itemBuilder: (context, index) {
                  return Text(
                    _consoleLogs[index],
                    style: TextStyle(
                      color: _consoleLogs[index].contains('ERR') ? Colors.red : const Color(0xFF00AAFF),
                      fontSize: 11,
                      fontFamily: 'monospace',
                    ),
                  );
                },
              ),
            ),

          // Status Bar
          InkWell(
            onTap: () => setState(() => _showConsole = !_showConsole),
            child: Container(
              width: double.infinity,
              padding: const EdgeInsets.all(6),
              color: const Color(0xFF00AAFF),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(_statusMessage.toUpperCase(), style: const TextStyle(color: Colors.black, fontWeight: FontWeight.bold, fontSize: 11)),
                  Text(_showConsole ? "HIDE LOGS" : "SHOW LOGS", style: const TextStyle(color: Colors.black, fontSize: 10)),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCard(VideoModel video) {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      height: 80,
      decoration: BoxDecoration(
        color: const Color(0xFF1E1E1E),
        borderRadius: BorderRadius.circular(4),
        border: Border.all(
          color: video.isCompleted ? Colors.green.withAlpha(200) : Colors.transparent,
        ),
      ),
      child: Row(
        children: [
          AspectRatio(
            aspectRatio: 16/9,
            child: FadeInImage.memoryNetwork(
              placeholder: kTransparentImage,
              image: video.thumbnailUrl,
              fit: BoxFit.cover,
              imageErrorBuilder: (c, o, s) => Container(color: Colors.grey[900]),
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  video.title,
                  maxLines: 1,
                  overflow: TextOverflow.ellipsis,
                  style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                ),
                Text(
                  video.channel,
                  style: TextStyle(color: Colors.grey[600], fontSize: 12),
                ),
              ],
            ),
          ),
          IconButton(
            onPressed: () => _download(video),
            icon: video.isDownloading
              ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2))
              : Icon(video.isCompleted ? Icons.check : Icons.download, color: const Color(0xFF00AAFF)),
          ),
          const SizedBox(width: 8),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./video_model.dart
// ==========================================

class VideoModel {
  final String id;
  final String title;
  final String channel;
  final String duration;
  final String thumbnailUrl;
  final String url;
  final String platform;
  bool isDownloading;
  bool isCompleted;

  VideoModel({
    required this.id,
    required this.title,
    required this.channel,
    required this.duration,
    required this.thumbnailUrl,
    required this.url,
    required this.platform,
    this.isDownloading = false,
    this.isCompleted = false,
  });

  factory VideoModel.fromJson(Map<String, dynamic> json) {
    return VideoModel(
      id: json['id'] ?? '',
      title: json['title'] ?? 'Unknown Title',
      channel: json['uploader'] ?? 'Unknown Channel',
      duration: json['duration_string'] ?? '0:00',
      thumbnailUrl: json['thumbnail'] ?? '',
      url: json['webpage_url'] ?? '',
      platform: json['extractor'] ?? 'unknown',
    );
  }
}

// ==========================================
// FILE: ./yt_service.dart
// ==========================================

import 'dart:convert';
import 'dart:io';
import 'video_model.dart';

class YtService {
  /// Determines download path - Defaulting to User Downloads for flexibility
  Future<String> get _downloadPath async {
    final home = Platform.environment['HOME'];
    // User Friendly Path: ~/Downloads/TheYT
    final userDownloads = Directory('$home/Downloads/TheYT');
    
    if (!await userDownloads.exists()) {
      await userDownloads.create(recursive: true);
    }
    return userDownloads.path;
  }

  /// Searches YouTube or fetches Metadata for a direct Link
  Future<List<VideoModel>> searchOrFetch(String query) async {
    List<String> args = [];

    if (query.startsWith('http')) {
      args = [query, '--dump-json', '--skip-download', '--flat-playlist'];
    } else {
      args = ['ytsearch20:$query', '--dump-json', '--skip-download', '--flat-playlist'];
    }

    try {
      final result = await Process.run('yt-dlp', args);
      if (result.exitCode != 0) return [];

      final List<VideoModel> videos = [];
      final lines = LineSplitter.split(result.stdout.toString());
      
      for (final line in lines) {
        if (line.trim().isNotEmpty) {
          try {
            final json = jsonDecode(line);
            videos.add(VideoModel.fromJson(json));
          } catch (e) {
            // Skip malformed lines
          }
        }
      }
      return videos;
    } catch (e) {
      print('Execution error: $e');
      return [];
    }
  }

  /// Downloads the video (1080p Cap)
  Future<void> downloadVideo(VideoModel video, Function(String) onLog) async {
    final savePath = await _downloadPath;
    
    // Greyway Quality Standard: 1080p Limit
    final qualityArgs = [
      '-f', 'bv*[height<=1080]+ba/b[height<=1080] / best',
      '--merge-output-format', 'mp4',
    ];

    List<String> finalArgs = [video.url, ...qualityArgs];

    // Smart Folder Logic
    if (video.url.contains('tiktok')) {
      final safeTitle = video.title.replaceAll(RegExp(r'[^a-zA-Z0-9_ -]'), '');
      final seriesDir = Directory('$savePath/$safeTitle');
      if (!await seriesDir.exists()) await seriesDir.create(recursive: true);
      
      finalArgs = [video.url, '--yes-playlist', '-o', '${seriesDir.path}/%(upload_date)s_%(title)s.%(ext)s'];
    } else if (video.url.contains('list=')) {
      final safeTitle = video.title.replaceAll(RegExp(r'[^a-zA-Z0-9_ -]'), '');
      final courseDir = Directory('$savePath/$safeTitle');
      if (!await courseDir.exists()) await courseDir.create(recursive: true);

      finalArgs = [video.url, ...qualityArgs, '-o', '${courseDir.path}/%(playlist_index)s_%(title)s.%(ext)s'];
    } else {
      finalArgs.addAll(['-o', '$savePath/%(title)s.%(ext)s']);
    }

    try {
      final process = await Process.start('yt-dlp', finalArgs);
      
      process.stdout.transform(utf8.decoder).listen((data) => onLog(data.trim()));
      process.stderr.transform(utf8.decoder).listen((data) => onLog('ERR: ${data.trim()}'));

      if (await process.exitCode == 0) {
        onLog('✅ COMPLETE');
      } else {
        onLog('❌ FAILED (Code ${await process.exitCode})');
      }
    } catch (e) {
      onLog('❌ SYS ERR: $e');
    }
  }
}
